kind: "BuildConfig"
apiVersion: "v1"
metadata:
  name: "microservice-springboot-bbva-pipeline"
spec:
  strategy:
    jenkinsPipelineStrategy:
      jenkinsfile: |-
        try {
             timeout(time: 20, unit: 'MINUTES') {
                node('maven') {
                    stage('build') {
                      openshift.withCluster() {
                         openshift.withProject() {
                            def bld = openshift.startBuild('bbvajava')
                            bld.untilEach {
                              return it.object().status.phase == "Running"
                            }
                            bld.logs('-f')
                         }  
                      }
                    }
                    stage("aprobar") {
                        input message: "Aprobar publicaci√≥n microservicio", id: "approval"
                      }
                    stage('deploy') {
                      openshift.withCluster() {
                        openshift.withProject() {
                          def dc = openshift.selector('dc', 'bbvajava')
                          dc.rollout().latest()
                        }
                      }
                    }
                  }
             }
          } catch (err) {
             echo "in catch block"
             echo "Caught: ${err}"
             currentBuild.result = 'FAILURE'
             throw err
          }    
      type: JenkinsPipeline
